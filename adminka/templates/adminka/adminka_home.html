{% extends 'adminka/adminka_base.html' %}

{% block content %}

    <h4>Все бронирования</h4>
    <form method="GET" class="mb-3 d-flex align-items-center gap-2">
        <label for="date-filter" class="form-label mb-0">Фильтр по дате:</label>
        <input type="date" id="date-filter" name="date" class="form-control w-auto" value="{{ request.GET.date }}">
        <button type="submit" class="btn btn-primary">Применить</button>
        <a href="{% url 'adminka_home' %}" class="btn btn-secondary">Сброс</a>
    </form>

    <table class="table table-hover">
        <thead>
        <tr>
            <th scope="col">№</th>
            <th scope="col">id</th>
            <th scope="col">Пользователь</th>
            <th scope="col">Бронь</th>
            <th scope="col">Дата бронирование</th>
            <th scope="col">Видео</th>
            <th scope="col">Удалить</th>
        </tr>
        </thead>
        <tbody>
        {% if bookings %}
            {% for booking in bookings %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <th scope="row">{{ booking.id }}</th>
                    <td>{{ booking.user }}</td>
                    <td>{{ booking.slot }}</td>
                    <td>{{ booking.created_at }}</td>
                    {% if booking.video %}
                        <td>
                            <a href="#"
                               class="video-link"
                               data-video-url="{{ booking.video }}"
                               data-bs-toggle="modal"
                               data-bs-target="#videoModal">
                                <i class="bi bi-camera-reels-fill"></i> Видео
                            </a>
                        </td>
                        <td>
                            <!-- Кнопка удаления видео -->
                            <form action="{% url 'delete_video' booking.id %}" method="POST"
                                  onsubmit="return confirm('Вы уверены, что хотите удалить это видео?');">
                                {% csrf_token %}
                                <button class="delete-video-btn" data-booking-id="{{ booking.id }}">
                                    Удалить видео
                                </button>
                            </form>
                        </td>
                    {% else %}
                        <td>
                        <td>
                            <!-- Кнопка для открытия модального окна -->
                            <button type="button" class="btn btn-primary btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#videoModal"
                                    data-booking-id="{{ booking.id }}">
                                <i class="bi bi-camera-video"></i> Добавить url видео
                            </button>
                        </td>
                        </td>
                    {% endif %}
                    <!-- Кнопка удаления -->
                    <td>
                        <button type="button" class="btn btn-danger btn-sm"
                                data-bs-toggle="modal" data-bs-target="#deleteModal"
                                data-booking-id="{{ booking.id }}">
                            <i class="bi bi-trash"></i> Удалить
                        </button>

                    </td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <!-- Модальное окно удаления -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="deleteForm" method="POST" action="{% url 'admin_delete_booking' 0 %}">
                    {% csrf_token %}
                    <input type="hidden" name="booking_id" id="modalBookingId">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteModalLabel">Подтверждение удаления</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Бронирование будет перемещено в архив. Укажите причину удаления:</p>
                        <div class="mb-3">
                            <textarea class="form-control" id="deleteComment" name="delete_comment" rows="3"
                                      required></textarea>
                            <div class="invalid-feedback">Пожалуйста, укажите причину удаления</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Удалить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- обработки кнопки удаления видео -->
    <script>
        // Пример обработки кнопки удаления видео
        document.querySelectorAll('.delete-video-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                if (confirm('Вы уверены, что хотите удалить видео?')) {
                    const response = await fetch(`/delete-video/${this.dataset.bookingId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        location.reload(); // или обновить только нужную часть страницы
                    }
                }
            });
        });
    </script>

    {#Бронирование перемещение в архив.#}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const deleteModal = document.getElementById('deleteModal');
            const deleteForm = document.getElementById('deleteForm');

            // Обработчик открытия модального окна
            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const bookingId = button.getAttribute('data-booking-id');
                document.getElementById('modalBookingId').value = bookingId;

                // Обновляем action формы с правильным ID
                const formAction = deleteForm.getAttribute('action').replace('/0/', `/${bookingId}/`);
                deleteForm.setAttribute('action', formAction);

                // Сброс формы
                deleteForm.reset();
            });

            // Обработчик отправки формы
            deleteForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const submitBtn = deleteForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;

                // Валидация
                if (!deleteForm.checkValidity()) {
                    deleteForm.classList.add('was-validated');
                    return;
                }

                // Блокируем кнопку
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Удаление...
        `;

                // Отправка формы стандартным способом
                fetch(deleteForm.action, {
                    method: 'POST',
                    body: new FormData(deleteForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Закрываем модальное окно
                            bootstrap.Modal.getInstance(deleteModal).hide();

                            // Показываем уведомление
                            showToast('success', 'Бронирование удалено', 'Бронирование успешно перемещено в архив');

                            // Обновляем страницу через 1 секунду
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            throw new Error(data.error || 'Неизвестная ошибка');
                        }
                    })
                    .catch(error => {
                        showToast('danger', 'Ошибка', error.message);
                        console.error('Ошибка удаления:', error);
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                    });
            });

            // Функция для показа уведомлений
            function showToast(type, title, message) {
                const toastContainer = document.getElementById('toastContainer') || createToastContainer();
                const toastId = 'toast-' + Date.now();

                const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        `;

                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                const toast = new bootstrap.Toast(document.getElementById(toastId));
                toast.show();

                // Автоматическое скрытие через 5 секунд
                setTimeout(() => toast.dispose(), 5000);
            }

            function createToastContainer() {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1100';
                document.body.appendChild(container);
                return container;
            }
        });
    </script>


    {#  js  добавление ссылк видео#}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Обработчик открытия модального окна
            const videoModal = document.getElementById('videoModal');
            if (videoModal) {
                videoModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const bookingId = button.getAttribute('data-booking-id');
                    document.getElementById('formBookingId').value = bookingId;
                });
            }

            // Обработчик отправки формы
            const videoForm = document.getElementById('videoForm');
            if (videoForm) {
                videoForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const form = e.target;
                    const bookingId = form.formBookingId.value;
                    const videoUrl = form.videoUrl.value;
                    const submitBtn = form.querySelector('button[type="submit"]');

                    // Валидация
                    if (!videoUrl) {
                        form.videoUrl.classList.add('is-invalid');
                        return;
                    }

                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status"></span>
                Сохранение...
            `;

                    try {
                        const response = await fetch(`/bookings/${bookingId}/video/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: JSON.stringify({video: videoUrl})
                        });

                        // Проверка ответа
                        if (!response.ok) {
                            const error = await response.json().catch(() => null);
                            throw new Error(error?.error || 'Ошибка сервера');
                        }

                        const result = await response.json();

                        if (result.success) {
                            // Закрываем модальное окно
                            bootstrap.Modal.getInstance(videoModal).hide();
                            // Показываем уведомление
                            showToast('success', 'Видео успешно сохранено');
                            // Обновляем страницу через 1 секунду
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            throw new Error(result.error || 'Неизвестная ошибка');
                        }
                    } catch (error) {
                        console.error('Ошибка:', error);
                        showToast('danger', `Ошибка: ${error.message}`);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Сохранить';
                    }
                });
            }

            // Функция для показа уведомлений
            function showToast(type, message) {
                const toastContainer = document.getElementById('toastContainer') || createToastContainer();
                const toastId = 'toast-' + Date.now();

                const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        `;

                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                new bootstrap.Toast(document.getElementById(toastId)).show();

                // Автоматическое скрытие через 5 секунд
                setTimeout(() => {
                    const toast = document.getElementById(toastId);
                    if (toast) toast.remove();
                }, 5000);
            }

            function createToastContainer() {
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                container.style.zIndex = '1100';
                document.body.appendChild(container);
                return container;
            }
        });
    </script>

    <!-- Модальное окно добавления видео -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="videoForm">
                    <input type="hidden" id="formBookingId" name="booking_id">
                    <div class="modal-header">
                        <h5 class="modal-title">Добавить видео</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="videoUrl" class="form-label">Ссылка на видео</label>
                            <input type="url" class="form-control" id="videoUrl" name="video"
                                   placeholder="https://example.com/video.mp4" required>
                            <div class="invalid-feedback">Пожалуйста, введите корректный URL</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}