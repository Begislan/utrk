{% extends 'adminka/adminka_base.html' %}

{% block content %}

    <h4>Все бронирования</h4>
    <form method="GET" class="mb-3 d-flex align-items-center gap-2">
        <label for="date-filter" class="form-label mb-0">Фильтр по дате:</label>
        <input type="date" id="date-filter" name="date" class="form-control w-auto" value="{{ request.GET.date }}">
        <button type="submit" class="btn btn-primary">Применить</button>
        <a href="{% url 'adminka_home' %}" class="btn btn-secondary">Сброс</a>
    </form>

    <table class="table table-hover">
        <thead>
        <tr>
            <th scope="col">№</th>
            <th scope="col">id</th>
            <th scope="col">Пользователь</th>
            <th scope="col">Бронь</th>
            <th scope="col">Дата бронирование</th>
            <th scope="col">Видео</th>
            <th scope="col">Удалить</th>
        </tr>
        </thead>
        <tbody>
        {% if bookings %}
            {% for booking in bookings %}
                <tr>
                    <th scope="row">{{ forloop.counter }}</th>
                    <th scope="row">{{ booking.id }}</th>
                    <td>{{ booking.user }}</td>
                    <td>{{ booking.slot }}</td>
                    <td>{{ booking.created_at }}</td>
                    {% if booking.video %}
                        <td>
                            <a href="#"
                               class="video-link"
                               data-video-url="{{ booking.video.url }}"
                               data-bs-toggle="modal"
                               data-bs-target="#videoModal">
                                <i class="bi bi-camera-reels-fill"></i> Видео
                            </a>
                        </td>
                        <td>
                            <!-- Кнопка удаления видео -->
                            <form action="{% url 'delete_video' booking.id %}" method="POST"
                                  onsubmit="return confirm('Вы уверены, что хотите удалить это видео?');">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning btn-sm mt-2">
                                    <i class="bi bi-trash"></i> Удалить видео
                                </button>
                            </form>
                        </td>
                    {% else %}
                        <td>
                            <i class="bi bi-plus-circle-fill text-primary"
                               role="button"
                               data-bs-toggle="modal"
                               data-bs-target="#uploadModal"
                               data-booking-id="{{ booking.id }}">
                            </i>
                        </td>
                    {% endif %}
                    <!-- Кнопка удаления -->
                    <td>
                        <form action="{% url 'admin_delete_booking' booking.id %}" method="POST"
                              onsubmit="return confirm('Вы уверены, что хотите удалить это бронирование?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Удалить
                            </button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
    </table>

    <!-- Модальное окно для воспроизведения видео -->
    <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoModalLabel">Воспроизведение видео</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <video id="videoPlayer" controls style="width: 100%;">
                        <source id="videoSource" src="" type="video/mp4">
                        Ваш браузер не поддерживает воспроизведение видео.
                    </video>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Обработчик события для открытия модального окна и загрузки видео
        document.addEventListener('DOMContentLoaded', function () {
            const videoLinks = document.querySelectorAll('.video-link');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoSource = document.getElementById('videoSource');
            const modal = document.getElementById('videoModal');
            const closeButton = modal.querySelector('.btn-close');

            videoLinks.forEach(function (link) {
                link.addEventListener('click', function (e) {
                    e.preventDefault(); // Предотвращаем стандартное поведение ссылки
                    const videoUrl = link.getAttribute('data-video-url');
                    videoSource.src = videoUrl;
                    videoPlayer.load(); // Загружаем новое видео
                    videoPlayer.play(); // Запускаем воспроизведение
                });
            });

            // Обработчик для кнопки закрытия модального окна (иконка "X")
            closeButton.addEventListener('click', function () {
                videoPlayer.pause(); // Останавливаем видео
                videoPlayer.currentTime = 0; // Сбрасываем видео в начало
            });

            // Также останавливаем видео, если модальное окно закрывается любым другим способом (например, при клике вне окна)
            modal.addEventListener('hidden.bs.modal', function () {
                videoPlayer.pause(); // Останавливаем видео
                videoPlayer.currentTime = 0; // Сбрасываем видео в начало
            });
        });
    </script>


    <!-- Модальное окно для загрузки видео -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Загрузить видео</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="bookingId" name="booking_id">
                        <input type="file" name="video" class="form-control" required>
                        <div class="mt-3 text-center" id="loadingIndicator" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3 w-100">Загрузить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let uploadModal = document.getElementById("uploadModal");
            uploadModal.addEventListener("show.bs.modal", function (event) {
                let button = event.relatedTarget;
                let bookingId = button.getAttribute("data-booking-id");
                document.getElementById("bookingId").value = bookingId;
            });

            document.getElementById("uploadForm").addEventListener("submit", function (e) {
                e.preventDefault();
                let formData = new FormData(this);
                let loadingIndicator = document.getElementById("loadingIndicator");
                loadingIndicator.style.display = "block";

                fetch("{% url 'upload_video' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        loadingIndicator.style.display = "none";
                        if (data.success) {
                            location.reload();
                        } else {
                            alert("Ошибка загрузки видео");
                        }
                    })
                    .catch(error => {
                        loadingIndicator.style.display = "none";
                        alert("Ошибка сети");
                    });
            });
        });
    </script>


{% endblock %}